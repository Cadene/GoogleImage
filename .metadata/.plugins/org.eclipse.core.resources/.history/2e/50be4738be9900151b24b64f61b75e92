package upmc.ri.bin;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Set;

import upmc.ri.struct.DataSet;
import upmc.ri.struct.Evaluator;
import upmc.ri.struct.STrainingSample;
import upmc.ri.struct.instantiation.MultiClass;
import upmc.ri.struct.model.LinearStructModel;
import upmc.ri.struct.model.LinearStructModel_Ex;
import upmc.ri.struct.ranking.RankingFunctions;
import upmc.ri.struct.ranking.RankingOutput;
import upmc.ri.struct.training.SGDTrainer;

public class Ranking {

	private DataSet<List<double[]>, RankingOutput> dataSet;
	
	public Ranking(DataSet<List<double[]>, RankingOutput> dataSet) {
		super();
		this.dataSet = dataSet;
	}
	
	public Ranking(String sourcePath, String classQuery) throws ClassNotFoundException, IOException {
		this(RankingFunctions.convertClassif2Ranking(VisualIndexes.load(sourcePath), classQuery));
	}

	public static void main(String[] args) throws ClassNotFoundException, IOException {
		int nbPCA = 250;
		String sourcePath = "/Vrac/3152691/RI_Image/bows_" + nbPCA + ".ser";
		String classQuery = european_fire_salamander;
		int dimpsi = 0;
		Set<String> classes;
		
		
		double eps = 1e1;
		double lambda = 2e-6;
		int maxIter = 20;
		
		
		
		Ranking ranking = new Ranking(sourcePath, classQuery);
		dimpsi = ranking.dataSet.listtest.get(0).input.length;
		classes = ranking.dataSet.outputs();
		MultiClass multiclass = new MultiClass(classes);
		LinearStructModel<double[], String> linear = new LinearStructModel_Ex<double[], String>(multiclass, dimpsi * classes.size());
		Evaluator<double[], String> evaluator = new Evaluator<double[], String>();
		evaluator.setModel(linear);
		evaluator.setListtrain(ranking.dataSet.listtrain);
		evaluator.setListtest(ranking.dataSet.listtest);
		SGDTrainer<double[], String> trainer = new SGDTrainer<double[], String>(evaluator, eps, lambda, maxIter);
		trainer.train(ranking.dataSet.listtrain, linear);
		evaluator.evaluate();
		System.out.println("Train Error : " + String.valueOf(evaluator.getErr_train()));
		System.out.println("Test  Error : " + String.valueOf(evaluator.getErr_test() ));
		ArrayList<String> predictions = new ArrayList<String>();
		ArrayList<String> gt = new ArrayList<String>();
		for (STrainingSample<double[], String> ts : ranking.dataSet.listtest) {
			predictions.add(linear.predict(ts));
			gt.add(ts.output);
		}
		multiclass.confusionMatrix(predictions, gt);
	}

}
